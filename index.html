async function carregarLinkExterno() {
    const url = document.getElementById('m3u-url').value.trim();
    if(!url) return alert("Por favor, cole um link primeiro.");
    
    // Mostra um aviso visual de que está a trabalhar
    const btn = document.querySelector('button');
    btn.innerText = "⌛...";
    
    try {
        // Tenta buscar os dados usando o Proxy AllOrigins
        const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
        const text = await res.text();
        
        if(text.includes("#EXTM3U")) {
            processarM3U(text);
            alert("Sucesso! Canais carregados.");
        } else {
            alert("O link foi lido, mas não parece ser uma lista IPTV válida.");
        }
    } catch(e) {
        alert("Erro Crítico: O servidor da sua lista bloqueou o acesso. Tente outro link.");
    } finally {
        btn.innerText = "CARREGAR";
    }
}

function processarM3U(data) {
    const lines = data.split('\n');
    const novosCanais = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line.startsWith('#EXTINF:')) {
            // Tenta extrair o nome do canal de forma mais inteligente
            let nome = "Canal Sem Nome";
            if (line.includes(',')) {
                nome = line.split(',').pop().trim();
            }
            
            // Tenta encontrar o logo se existir (tvg-logo)
            const logoMatch = line.match(/tvg-logo="([^"]+)"/);
            const logo = logoMatch ? logoMatch[1] : "https://via.placeholder.com/50";
            
            // O link do canal costuma estar na linha seguinte ou duas abaixo
            let link = "";
            for (let j = i + 1; j < i + 4 && j < lines.length; j++) {
                if (lines[j].trim().startsWith('http')) {
                    link = lines[j].trim();
                    break;
                }
            }
            
            if(link) {
                novosCanais.push({ nome, url: link, logo });
            }
        }
    }
    
    if(novosCanais.length > 0) {
        render(novosCanais);
        // Esconde os canais de teste para mostrar os teus
        document.querySelector('h3').innerText = "A Tua Lista (" + novosCanais.length + " canais)";
    }
}
